name: Deploy Test

# æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã™
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging

jobs:
  deploy-test:
    runs-on: ubuntu-latest
    
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ã‚¹ãƒ†ãƒƒãƒ—2: PHPã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, intl, pdo_mysql
          coverage: none
          
      # ã‚¹ãƒ†ãƒƒãƒ—3: Composerã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          if [ -f "composer.json" ]; then
            composer install --no-interaction --prefer-dist --optimize-autoloader
          else
            echo "composer.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi
          
      # ã‚¹ãƒ†ãƒƒãƒ—4: åŸºæœ¬çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
      - name: Check PHP syntax
        run: |
          find . -name "*.php" -not -path "./vendor/*" -print0 | xargs -0 -n1 php -l
          
      # ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆã®ä»£ã‚ã‚Šã«ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã¨ç’°å¢ƒæƒ…å ±ã‚’è¡¨ç¤º
      - name: Display deployment information
        run: |
          echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
          echo "ğŸŒ ç’°å¢ƒ: ${{ github.event.inputs.environment }}"
          echo "ğŸ“‚ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
          find . -type f -not -path "./.git/*" -not -path "./vendor/*" | wc -l
          echo "ğŸ“Š PHP ãƒ•ã‚¡ã‚¤ãƒ«æ•°:"
          find . -name "*.php" -not -path "./vendor/*" | wc -l

      # ã‚¹ãƒ†ãƒƒãƒ—6: å®Œäº†é€šçŸ¥
      - name: Finish test deployment
        run: |
          echo "âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ” å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¯ã€ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå¿…è¦ã§ã™ï¼š"
          echo "  - SSH_PRIVATE_KEY"
          echo "  - SERVER_HOST"
          echo "  - SERVER_USER"
          echo "  - SERVER_PORT"
          echo "  - DEPLOY_PATH" 